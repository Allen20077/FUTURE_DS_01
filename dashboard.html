{% extends "base.html" %}
{% block content %}

<h1>ðŸ“Š Sales Performance Dashboard</h1>
<div style="display:flex; gap:20px; margin-bottom:25px; flex-wrap:wrap;">

    <select id="regionFilter" class="filter">
        <option>All</option>
        <option>North</option>
        <option>South</option>
        <option>East</option>
        <option>West</option>
    </select>

    <select id="categoryFilter" class="filter">
        <option>All</option>
        <option>Electronics</option>
        <option>Accessories</option>
    </select>

</div>

<!-- KPI CARDS -->
<div class="kpi-row">
  <div class="kpi-card blue">
    <h3>Total Orders</h3>
    <p>{{ total_orders }}</p>
  </div>
  <div class="kpi-card teal">
    <h3>Sales Revenue</h3>
    <p>â‚¹ {{ total_revenue }}</p>
  </div>
  <div class="kpi-card green">
    <h3>Profit</h3>
    <p>â‚¹ {{ total_revenue * 0.3 | int }}</p>
  </div>
</div>
<div class="kpi-row">
    <i class="fa-solid fa-dollar-sign big-icon gradient icon-hover"></i>
    <p class="kpi-value counter" data-target="7200000">0</p>
</div>
<div class="card kpi-card">
    <svg class="svg-icon tooltip" data-tip="Revenue Growth">
        <use href="#icon-growth"></use>
    </svg>

    <p class="kpi-value counter" data-target="1800000">0</p>
    <small>Growth</small>
</div>

<!-- ROW 2 -->
<div class="grid-2">
  <div class="card">
    <h3>Sales vs Target</h3>
    <canvas id="donutChart"></canvas>
  </div>

  <div class="card">
    <h3>Yearly Revenue Trend</h3>
    <canvas id="revenueBar"></canvas>
  </div>
</div>
<div class="card">
    <h3>Revenue by Product</h3>
    <canvas id="productBar"></canvas>
</div>


<!-- ROW 3 -->
<div class="grid-3">
  <div class="card">
    <h4>Avg Revenue / Unit</h4>
    <p class="big">â‚¹145</p>
  </div>
  <div class="card">
    <h4>Monthly Sales Growth</h4>
    <canvas id="monthlyGrowth"></canvas>
  </div>
  <div class="card">
    <h4>Region Performance</h4>
    <canvas id="regionPie"></canvas>
  </div>
</div>
<div class="card">
    <div class="card-header">
        <i class="fa-solid fa-arrow-trend-up big-icon gradient icon-hover"></i>
        <h3>Forecast Growth</h3>
    </div>

    <p class="kpi-value counter" data-target="1800000">0</p>
</div>
<!-- CHARTS SCRIPT -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  
/* Donut Chart */
new Chart(document.getElementById('donutChart'), {
  type: 'doughnut',
  data: {
    labels: ['Achieved', 'Remaining'],
    datasets: [{
      data: [75, 25],
      backgroundColor: ['#8bc34a', '#2e7d32']
    }]
  }
});

/* Revenue Bar */
new Chart(document.getElementById('revenueBar'), {
  type: 'bar',
  data: {
    labels: ['2019','2020','2021','2022','2023','2024'],
    datasets: [{
      label: 'Revenue',
      data: [20,30,45,40,35,25],
      backgroundColor: '#cddc39'
    }]
  }
});

/* Monthly Growth */
new Chart(document.getElementById('monthlyGrowth'), {
  type: 'bar',
  data: {
    labels: ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'],
    datasets: [{
      data: [5,8,10,12,15,18,20,22,25,27,29,30],
      backgroundColor: '#607d8b'
    }]
  }
});

/* Region Pie */
new Chart(document.getElementById('regionPie'), {
  type: 'pie',
  data: {
    labels: {{ region_sales.keys() | list | tojson }},
    datasets: [{
      data: {{ region_sales.values() | list | tojson }},
      backgroundColor: ['#4caf50','#8bc34a','#cddc39']
    }]
  }
});
</script>
<script>
let regionChart;

function loadFilteredChart() {
    const region = document.getElementById("regionFilter").value;
    const category = document.getElementById("categoryFilter").value;

    fetch(`/api/filtered-data?region=${region}&category=${category}`)
        .then(res => res.json())
        .then(data => {

            if (regionChart) regionChart.destroy();

            regionChart = new Chart(
                document.getElementById("revenueBar").getContext("2d"),
                {
                    type: "bar",
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: "Revenue",
                            data: data.values,
                            backgroundColor: "#4dabf7",
                            borderRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { display: false } }
                    }
                }
            );
        });
}

document.getElementById("regionFilter").addEventListener("change", loadFilteredChart);
document.getElementById("categoryFilter").addEventListener("change", loadFilteredChart);

loadFilteredChart();
</script>

{% endblock %}